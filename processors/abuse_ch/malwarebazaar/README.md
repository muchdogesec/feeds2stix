# malwarebazaar

## tl;dr logic of the script

The script works like so

1. Downloads the data from `https://bazaar.abuse.ch/export/csv/full/`
2. reads the body of the response, only considering CLI argument values entered by user
3. for user entered signature entry or first unique signature entry identified in csv, turns the entries found in the csv into STIX objects (as described in this doc). STIX objects are stored to the filesystemstore in `bundles/abuse_ch/malwarebazaar/stix2_objects`.
4. the created objects are packaged in a STIX 2.1 bundle for each signature
5. If no `signature` value passed to cli, script moves back to step 3 to next signature object until all malwares are covered

Note this script can handle updates to data in a graceful way. Because a copy of all STIX `bundles/abuse_ch/malwarebazaar/stix2_objects` is stored the script does not need to process all data on each run. On update runs the script will only consider data greater than the highest `modified` time for the malware object linked to the signature specified.

## Overview

> MalwareBazaar is a project from abuse.ch with the goal of sharing malware samples with the infosec community, AV vendors and threat intelligence providers.

https://bazaar.abuse.ch/

## Data source

https://bazaar.abuse.ch/export/csv/full/

## Data schema

```
################################################################
# MalwareBazaar full malware samples dump (CSV)                #
# Last updated: 2024-07-16 08:31:16 UTC                        #
#                                                              #
# Terms Of Use: https://bazaar.abuse.ch/faq/#tos               #
# For questions please contact bazaar [at] abuse.ch            #
################################################################
#
# "first_seen_utc","sha256_hash","md5_hash","sha1_hash","reporter","file_name","file_type_guess","mime_type","signature","clamav","vtpercent","imphash","ssdeep","tlsh"
"2024-07-16 08:31:16", "2e376f05023790d577a4d2e110640410c9d65c145d2d02e207ff07c3271ea095", "93bd5e209b3b048fa37073d7890c44d9", "da79764ed539c57542c523c28c878f6377c258a6", "SecuriteInfoCom", "SecuriteInfo.com.Win32.PWSX-gen.14862.32498", "exe", "application/x-dosexec", "n/a", "n/a", "38.36", "f34d5f2d4577ed6d9ceec516c1f5a744", "12288:T5AHEbpo6zQSxn/hqJdmVC7KDpmfYicDXFsQo1mbumYQdRlF6u:aIpo6zVQrg1RmmKm9Rv6u", "T11BF423117BFC8364C27E2B3A6074425953B1B1175863DBAF5F1CB08D2F5B3518AB3662"
"2024-07-16 08:09:21", "36ec708af0e23aa5e6cfa50dbb4327cad9c5bf25740ab5b38c7a89cf2d6617b8", "d38821792f768551b015a982c0ddd1d5", "426aff05acfcfd800a4c6f0b77fe3e92d491c3ec", "NDA0E", "gdfvr.hta", "hta", "text/html", "n/a", "n/a", "29.69", "n/a", "768:tZ6A3yXNA0AGAhUybo5ynoitI0AOgDsXxJRQiXAZO:tXFGU5", "T1E2E37C579203E53D592358FFEA3CEED110D0DE9ADBC89A4344FE5419ABE0F9CB608486"
"2024-07-16 08:07:00", "1a295933a80907bda689b231e5295eae86bd19b21964ee8669ceb5598c9d714d", "8a43a10dc1358f554584a7e8c5dfdf1a", "421b526ab7b03c4fb1529af55074b4cf1fba30af", "NDA0E", "rud.scr", "exe", "application/x-dosexec", "Loki", "n/a", "49.32", "f34d5f2d4577ed6d9ceec516c1f5a744", "6144:RwgMufVBLKEbbfYeBxZGZ+fGvcaZYE6DMQRWXu9laoMBZXVseAzBL/1nW3r3CvEa:RwfufVLG+fGvqEQqBV2hWuhb", "T1B1B4CF21A7FD6B5EF6FE1F33B7A600208B76BE22692BD35C44C4587906A3741D612723"
"2024-07-16 07:40:16", "f54bcd9b8d1f71019f83f0116ec50209aed422590555f228450da3492df76005", "59a2ee23e99471bd12e281f5a951ea04", "59cccb68067aff54b7fd81886928189599170f6a", "Bitsight", "file", "exe", "application/x-dosexec", "n/a", "n/a", "25.68", "948cc502fe9226992dce9417f952fce3", "24576:KqDEvCTbMWu7rQYlBQcBiT6rprG8aLE2Sbly7TWEPje:KTvC/MTQYxsWR7aLE2dW", "T19445BF0273D1D022FFAB92334B5BF6515ABC69260123E62F13981D79BE701B1563E7A3"
"2024-07-16 07:39:18", "1ccf2435674e5a774cbb63f1177f3ae6c592ccf152bb50986cb80e6a76c24857", "256d0da4bcd96d9016aae187faa7abc5", "3ff5126831d735d05288b541e3bfcd60a75cba1c", "cocaman", "Quotation.xls", "xls", "application/vnd.ms-excel", "n/a", "n/a", "33.85", "n/a", "12288:nTi7oLDHaQZ9Dpr6iiqtoRIGw2jqd0nm9wr:lay9DpWet2Ygaw", "T1FDA42288BB9AC703DD0B42BA46D546935424FE552FC3D617F084BB1DC8BAF639901BAC"
[...more records...]
# Number of entries: 1217668
```

Where `[...more records...]` is more rows removed for brevity here.

The last row should be ignored.

The results of this file are sorted by `first_seen_utc` in descending day order. The results inside a day are not necessarily in the time order. e.g. results will always be in order `2024-07-16`, `2024-07-15`, `2024-07-14`, etc. but could be in order `2024-07-16 06:45:19`, `2024-07-16 08:11:39`, `2024-07-16 05:25:36`

## Data Normalisation

n/a

## STIX objects

### Imported objects:

* marking-definition: https://raw.githubusercontent.com/muchdogesec/stix4doge/main/objects/marking-definition/feeds2stix.json
* identity: https://raw.githubusercontent.com/muchdogesec/stix4doge/main/objects/identity/feeds2stix.json

### Generated object mappings

#### Marking Definition

This is hardcoded and never changes;

```json
{
    "type": "marking-definition",
    "spec_version": "2.1",
    "id": "marking-definition--19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb",
    "created_by_ref": "identity--a1cb37d2-3bd3-5b23-8526-47a22694b7e0",
    "created": "2020-01-01T00:00:00.000Z",
    "definition_type": "statement",
    "definition": {
        "statement": "Origin data source: https://bazaar.abuse.ch/export/csv/full/"
    },
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "marking-definition--a1cb37d2-3bd3-5b23-8526-47a22694b7e0"
    ]
}
```

#### Observables 

For each entry, observables can be created as follows;

```json
{
    "type": "file",
    "spec_version": "2.1",
    "id": "file--<GENERATED BY STIX2 LIB>",
    "name": "<file_name><.file_type_guess (if exists and is not unknown)>",
    "mime_type": "<mime_type>",
    "hashes": {
        "MD5": "<md5_hash>",
        "SHA-1": "<sha1_hash>",
        "SHA-256": "<sha256_hash>",
        "SSDEEP": "<ssdeep>"
    }
}
```

#### Indicators 

For each file, an Indicator object is created as follows

```json
{
    "type": "indicator",
    "spec_version": "2.1",
    "id": "indicator--<UUIDV5>",
    "created_by_ref": "identity--a1cb37d2-3bd3-5b23-8526-47a22694b7e0",
    "created": "Earliest <first_seen_utc> for all records of this file",
    "modified": "Latest <last_seen_utc> for all records of this file",
    "indicator_types": [
        "malicious-activity"
    ],
    "name": "<file_name><.file_type_guess (if exists and is not unknown)>",
    "pattern": "([ file:hashes.'MD5' = '<md5_hash>' ] OR [ file:hashes.'SHA-1' = '<sha1_hash>' ] OR [ file:hashes.'SHA-256' = '<sha256_hash>' ] OR [ file:hashes.'SSDEEP' = '<ssdeep>' ])",
    "pattern_type": "stix",
    "valid_from": "Same as `created` value",
    "labels": [
        "all unique tags for observables linked to this malware as a list"
    ],
    "confidence": "highest <vtpercent>",
    "external_references": [
        {
            "source_name": "malwarebazaar_reporter[n]",
            "external_id": "<reporter>"
        }
    ],
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "marking-definition--19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb",
        "marking-definition--418465b1-2dbe-41b7-b994-19817164e793"
    ]
  }
```

UUIDv5 is generated using namespace `19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb` and `name` value

#### Malware

If the file has a `signature` then a malware object is created as follows

```json
{
    "type": "malware",
    "spec_version": "2.1",
    "id": "malware--<UUIDV5>",
    "created_by_ref": "identity--a1cb37d2-3bd3-5b23-8526-47a22694b7e0",
    "created": "Earliest <first_seen_utc> for all records of this file",
    "modified": "Latest <last_seen_utc> for all records of this file",
    "name": "<signature>",
    "malware_types": [
        "unknown"
    ],
    "is_family": true,
    "sample_refs": [
        "<all file object records that have this signature>"
    ],
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "marking-definition--19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb",
        "marking-definition--418465b1-2dbe-41b7-b994-19817164e793"
    ]
}
```

UUIDv5 is generated using namespace `19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb` and `name` value

Each indicator created is then linked to the malware objects like so;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<Indicator UUID>",
    "created_by_ref": "identity--a1cb37d2-3bd3-5b23-8526-47a22694b7e0",
    "created": "<INDICATOR CREATED TIME>",
    "modified": "<INDICATOR MODIFIED TIME>",
    "relationship_type": "detects",
    "source_ref": "indicator--<ID>",
    "target_ref": "malware--<ID>",
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "marking-definition--19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb",
        "marking-definition--418465b1-2dbe-41b7-b994-19817164e793"
    ]
}
```

UUIDv5 is generated using namespace `19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb` and `source_ref+target_ref`

And each object listed in the pattern of the Indicator is linked to it like so;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<UUIDV5>",
    "created": "<INDICATOR CREATED TIME>",
    "modified": "<INDICATOR MODIFIED TIME>",
    "relationship_type": "detects",
    "source_ref": "indicator--<ID>",
    "target_ref": "file--<ID>",
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "marking-definition--19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb",
        "marking-definition--418465b1-2dbe-41b7-b994-19817164e793"
    ]
}
```

UUIDv5 is generated using namespace `19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb` and `source_ref+target_ref`

All the generated objects are placed into STIX bundles in the directory `bundles/abuse_ch/malwarebazaar`.

A bundle is per malware `name`;

```json
{
    "type": "bundle",
    "id": "bundle--<UUIDV5>",
    "objects": [
        "ALL STIX OBJECTS CREATED"
    ]
}
```

The UUID is generated using the namespace `19ca6f7b-4055-4ed5-b3d7-4b2a4f403cbb` and an md5 of all the sorted objects in the bundle.

Any `(` and `)` characters in the `name` value are removed before saving the bundle filename. All `-` characters are replaced with `_`

All objects that are not linked to a malware objects, are packed into a separate bundle per year with the following naming conventions `2024_unclassified.json`, `2023_unclassified.json`, etc (with time based on `modified` time in Indicator objects)

## Run the script

```shell
python3 processors/abuse_ch/malwarebazaar/malwarebazaar.py --update
```

Where:

* `update` (optional): if passed will search for the highest `modified` time in stix2objects. The script will identify if any new data has been added since `modified` and script run time. If true, then the new observables will be added, and indicator/malware/bundle updated / added to reflect changes.